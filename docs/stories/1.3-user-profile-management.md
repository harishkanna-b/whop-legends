# Story 1.3: User Profile Management and Character Classes

## Status
Completed

## Story
**As a** user,
**I want** to select a character class and track my progression through levels and achievements,
**so that** I can see my growth and accomplishments in the referral gamification system.

## Acceptance Criteria
1. Character class selection system with three distinct classes (Scout, Sage, Champion)
2. Progressive leveling system based on successful referrals with level-based unlocks
3. User profiles displaying level, XP, achievements, and referral history
4. Automatic class assignment for new users based on referral patterns

## Tasks / Subtasks

- [x] Set up character class system (AC: 1)
  - [x] Define character class data model and database schema
  - [x] Implement three character classes: Scout, Sage, Champion
  - [x] Create class selection interface and logic
  - [x] Define XP multipliers and progression paths for each class

- [x] Build leveling system (AC: 2)
  - [x] Implement XP calculation algorithms
  - [x] Create level progression thresholds and requirements
  - [x] Build level-up notification system
  - [x] Implement level-based unlock mechanics

- [x] Create user profile management (AC: 3)
  - [x] Design user profile interface and components
  - [x] Implement profile data management and storage
  - [x] Create achievement tracking and display system
  - [x] Build referral history and statistics tracking

- [x] Implement automatic class assignment (AC: 4)
  - [x] Analyze referral patterns for new users
  - [x] Create intelligent class recommendation system
  - [x] Implement auto-assignment logic with override option

## Dev Notes

### Previous Story Insights
From Story 1.2 (Whop Integration and Webhook Setup):
- Whop API integration is complete with webhook processing
- User creation and basic profile management is implemented
- Webhook events for referral.created, referral.completed, referral.cancelled are handled
- Database schema includes users, referrals, and basic progression tracking

### Data Models
**Character Classes** [Source: FR2]
- Class types: Scout (speed/reach), Sage (value/quality), Champion (volume/consistency)
- XP multipliers: Scout (1.2x reach), Sage (1.5x value), Champion (1.3x volume)
- Class-specific abilities and progression paths
- Class change mechanics and restrictions

**Leveling System** [Source: FR3]
- XP calculation based on referral value and completion
- Level thresholds with increasing requirements
- Level-up celebrations and notifications
- Unlockable content and features per level

**User Profiles** [Source: FR6]
- Profile data: level, XP, class, achievements, referral history
- Achievement categories and rarity system
- Statistics and performance metrics
- Social profile elements for leaderboards

### API Specifications
**Character Class Management** [Source: FR2]
- Class selection endpoint: POST /api/user/class
- Class information endpoint: GET /api/classes/{classId}
- Class change endpoint: PUT /api/user/class
- Class recommendation endpoint: GET /api/user/class/recommendation

**User Profile Management** [Source: FR6]
- Profile retrieval: GET /api/user/profile
- Profile update: PUT /api/user/profile
- Achievement tracking: GET /api/user/achievements
- Referral history: GET /api/user/referrals

**Leveling System** [Source: FR3]
- XP calculation: POST /api/user/xp/calculate
- Level progression: GET /api/user/level/progress
- Level history: GET /api/user/level/history
- Unlocks by level: GET /api/unlocks/level/{level}

### Component Specifications
**API Routes** [Source: FR2, FR3, FR6]
- `/api/user/class` - Character class management
- `/api/user/profile` - User profile CRUD operations
- `/api/user/level` - Level progression tracking
- `/api/achievements` - Achievement system
- `/api/classes` - Character class information

**Database Models** [Source: FR2, FR3, FR6]
- `character_classes` - Class definitions and attributes
- `user_levels` - User progression tracking
- `achievements` - Achievement definitions and user progress
- `user_achievements` - User-specific achievement unlocks

**Utility Functions** [Source: FR2, FR3, FR6]
- Character class assignment logic
- XP calculation algorithms
- Level progression validation
- Achievement unlocking logic

### File Locations
**API Routes** [Source: FR2, FR3, FR6]
- Character class management: `pages/api/user/class.ts`
- Profile management: `pages/api/user/profile.ts`
- Level tracking: `pages/api/user/level.ts`
- Achievements: `pages/api/achievements.ts`

**Core Implementation** [Source: FR2, FR3, FR6]
- Character classes: `lib/character-classes.ts`
- Leveling system: `lib/leveling.ts`
- Profile management: `lib/user-profile.ts`
- Achievements: `lib/achievements.ts`

**Database Schemas** [Source: FR2, FR3, FR6]
- Character classes: `lib/schemas/character-classes.ts`
- User progression: `lib/schemas/user-progression.ts`
- Achievements: `lib/schemas/achievements.ts`

### Testing Requirements
**Character Class Testing Strategy** [Source: FR2]
- Unit tests for class selection logic
- Integration tests for XP multiplier calculations
- Class change validation tests
- Recommendation algorithm testing

**Leveling System Testing** [Source: FR3]
- XP calculation accuracy across scenarios
- Level progression threshold validation
- Level-up notification system tests
- Unlock mechanism verification

**User Profile Testing** [Source: FR6]
- Profile data integrity tests
- Achievement tracking validation
- Referral history accuracy tests
- Performance under load testing

**Specific Testing Requirements for this Story**
- Test character class selection and assignment
- Validate XP calculation for different referral scenarios
- Test level progression thresholds and notifications
- Verify achievement unlocking logic
- Test user profile data consistency
- Validate class change restrictions and mechanics

### Technical Constraints
**Character Class System** [Source: FR2]
- Must support exactly three character classes with distinct playstyles
- XP multipliers must be balanced to prevent class dominance
- Class changes should have restrictions to prevent exploitation
- Must integrate with existing user database schema

**Leveling System** [Source: FR3]
- XP calculations must be deterministic and verifiable
- Level thresholds must scale appropriately with user progression
- Must handle edge cases (negative XP, level loss scenarios)
- Level-ups must trigger appropriate notifications and unlocks

**User Profile System** [Source: FR6]
- Profile data must be real-time and consistently updated
- Achievement system must support retroactive awarding
- Must handle large volumes of referral history data
- Profile updates must be atomic and conflict-free

### Performance Requirements
**Response Times** [Source: NFR1]
- Profile retrieval: <100ms
- Class selection: <200ms
- XP calculation: <50ms
- Level progression: <100ms

**Scalability** [Source: NFR5]
- Support 10,000 concurrent profile views
- Handle 1,000+ level-up events per minute
- Process achievement unlocks in real-time
- Manage profile updates without conflicts

**Database Performance** [Source: NFR1]
- Profile queries: <50ms
- Achievement tracking: <100ms
- Level progression writes: <200ms
- Referral history queries: <150ms

### Security Requirements
**Data Privacy** [Source: NFR11]
- User profile data must be protected with appropriate access controls
- Achievement data must be validated to prevent cheating
- Class changes must be authorized and audited
- XP manipulation must be prevented through validation

**Access Control** [Source: NFR6]
- Profile updates must be restricted to profile owners
- Class selection must be validated for eligibility
- Achievement unlocks must be verified for legitimacy
- Level progression must be tamper-proof

### Project Structure Alignment
- Builds upon Story 1.1 database schema and user tables
- Extends Story 1.2 user management and webhook processing
- Integrates with existing authentication and authorization systems
- Leverages established RLS policies for data security

## Testing
**Character Class Testing Standards** [Source: FR2]
- Test file location: `__tests__/character-classes/`
- Use Jest + Supabase testing utilities
- Mock class selection scenarios and edge cases
- Test XP multiplier calculations and validation

**Leveling System Testing Standards** [Source: FR3]
- Test file location: `__tests__/leveling/`
- Comprehensive XP calculation scenario testing
- Level progression threshold validation
- Level-up notification system testing

**User Profile Testing Standards** [Source: FR6]
- Test file location: `__tests__/user-profile/`
- Profile data integrity and consistency testing
- Achievement tracking and unlock validation
- Referral history accuracy and performance testing

**Specific Testing Requirements for this Story**
- Test character class selection with all three classes
- Validate XP calculation for different referral values and types
- Test level progression at various thresholds
- Verify achievement unlocking conditions and logic
- Test user profile creation and updates
- Validate class recommendation algorithm accuracy
- Test profile data consistency under concurrent updates
- Verify level-up notification delivery
- Test achievement retroactive awarding logic

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-17 | v1.0 | Initial story creation based on FR2, FR3, FR6 | Development Team |
| 2025-09-17 | v1.1 | Complete implementation with character classes, leveling system, user profiles, and comprehensive testing | Development Team |