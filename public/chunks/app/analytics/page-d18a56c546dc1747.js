(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1745],{196:(e,t,a)=>{Promise.resolve().then(a.bind(a,4132))},4132:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>p});var s=a(5010),r=a(8602),n=a(9030);class i{async getDashboardData(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"30d",a="dashboard_".concat(e,"_").concat(t),s=this.cache.get(a);if(s&&Date.now()-s.timestamp<this.CACHE_DURATION)return s.data;let[r,n,i,l,c]=await Promise.all([this.getOverviewData(e,t),this.getAnalyticsMetrics(e,t),this.getTopPerformers(e,10),this.getRecentActivity(e,20),this.generateCreatorInsights(e)]),o={overview:r,metrics:n,top_performers:i,recent_activity:l,insights:c};return this.cache.set(a,{data:o,timestamp:Date.now()}),o}async getOverviewData(e,t){let a=new Date,s=this.getTimeframeStartDate(t),{data:r,error:i}=await n.N.from("user_profiles").select("id, created_at, total_referrals, total_commission, is_active").eq("company_id",e);if(i)throw i;let{data:l,error:c}=await n.N.from("referrals").select("id, created_at, converted_at, commission_amount").eq("company_id",e).gte("created_at",s.toISOString());if(c)throw c;let o=(null==r?void 0:r.length)||0,d=(null==r?void 0:r.filter(e=>e.is_active).length)||0,m=(null==l?void 0:l.length)||0,g=(null==l?void 0:l.reduce((e,t)=>e+(t.commission_amount||0),0))||0,h=(null==l?void 0:l.filter(e=>e.converted_at).length)||0,x=new Date(s.getTime()-(a.getTime()-s.getTime())),{data:u}=await n.N.from("referrals").select("id, created_at, commission_amount").eq("company_id",e).gte("created_at",x.toISOString()).lt("created_at",s.toISOString()),p=(null==u?void 0:u.length)||0,y=(null==u?void 0:u.reduce((e,t)=>e+(t.commission_amount||0),0))||0;return{total_members:o,active_members:d,total_referrals:m,total_commission:g,average_conversion_rate:m>0?h/m*100:0,member_growth_rate:o>0?(o-p)/p*100:0,revenue_growth_rate:g>0?(g-y)/y*100:0}}async getAnalyticsMetrics(e,t){let a=this.getTimeframeStartDate(t),{data:s,error:r}=await n.N.from("analytics_aggregations").select("*").eq("company_id",e).gte("date",a.toISOString()).order("date",{ascending:!0});if(r)throw r;if(!s||0===s.length)return this.generateMockMetrics(e,t);let i=[],l=s.map(e=>e.total_referrals||0),c=this.calculateChange(l);i.push({id:"".concat(e,"_referrals_").concat(t),name:"Total Referrals",type:"referrals",value:l[l.length-1]||0,change:Math.abs(c),change_type:c>=0?"increase":"decrease",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()});let o=s.map(e=>e.total_commission||0),d=this.calculateChange(o);i.push({id:"".concat(e,"_commission_").concat(t),name:"Total Commission",type:"commission",value:o[o.length-1]||0,change:Math.abs(d),change_type:d>=0?"increase":"decrease",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()});let m=s.map(e=>e.active_users||0),g=this.calculateChange(m);i.push({id:"".concat(e,"_engagement_").concat(t),name:"Active Members",type:"engagement",value:m[m.length-1]||0,change:Math.abs(g),change_type:g>=0?"increase":"decrease",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()});let h=s.map(e=>e.conversion_rate||0),x=this.calculateChange(h);return i.push({id:"".concat(e,"_conversion_").concat(t),name:"Conversion Rate",type:"conversion",value:h[h.length-1]||0,change:Math.abs(x),change_type:x>=0?"increase":"decrease",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()}),i}async getTopPerformers(e,t){let{data:a,error:s}=await n.N.from("member_performance_stats").select("\n        user_id,\n        username,\n        avatar,\n        total_referrals,\n        total_commission,\n        conversion_rate,\n        engagement_score,\n        retention_rate,\n        quest_completion_rate,\n        last_active,\n        join_date,\n        character_class,\n        level\n      ").eq("company_id",e).order("total_commission",{ascending:!1}).limit(t);if(s)throw s;return(a||[]).map((e,t)=>({id:e.user_id,user_id:e.user_id,username:e.username,avatar:e.avatar,total_referrals:e.total_referrals||0,total_commission:e.total_commission||0,conversion_rate:e.conversion_rate||0,engagement_score:e.engagement_score||0,retention_rate:e.retention_rate||0,quest_completion_rate:e.quest_completion_rate||0,last_active:e.last_active,join_date:e.join_date,character_class:e.character_class,level:e.level||1,rank:t+1}))}async getRecentActivity(e,t){let{data:a,error:s}=await n.N.from("recent_activity").select("*").eq("company_id",e).order("timestamp",{ascending:!1}).limit(t);if(s)throw s;return(a||[]).map(e=>({id:e.id,user_id:e.user_id,username:e.username,action:e.action,value:e.value,timestamp:e.timestamp}))}async generateCreatorInsights(e){let t=[],a=new Date().toISOString(),{data:s}=await n.N.from("member_performance_stats").select("*").eq("company_id",e).order("last_active",{ascending:!1});if(!s||0===s.length)return t;let r=s.reduce((e,t)=>e+(t.engagement_score||0),0)/s.length;r<50&&t.push({id:"".concat(e,"_low_engagement_").concat(a),type:"warning",category:"engagement",title:"Low Member Engagement",description:"Average engagement score is ".concat(r.toFixed(1),"%. Consider implementing engagement strategies."),data:{avg_engagement:r},actionable:!0,priority:"high",created_at:a});let i=s.filter(e=>(e.total_commission||0)>1e3);i.length>0&&t.push({id:"".concat(e,"_top_performers_").concat(a),type:"achievement",category:"performance",title:"Top Performers Identified",description:"".concat(i.length," members have generated over $1000 in commission."),data:{top_performers:i.length},actionable:!0,priority:"medium",created_at:a});let l=s.reduce((e,t)=>e+(t.conversion_rate||0),0)/s.length;return l>30&&t.push({id:"".concat(e,"_high_conversion_").concat(a),type:"opportunity",category:"growth",title:"High Conversion Rate",description:"Average conversion rate is ".concat(l.toFixed(1),"%. Consider scaling successful strategies."),data:{avg_conversion:l},actionable:!0,priority:"medium",created_at:a}),t}getTimeframeStartDate(e){let t=new Date;switch(e){case"7d":return new Date(t.getTime()-6048e5);case"30d":default:return new Date(t.getTime()-2592e6);case"90d":return new Date(t.getTime()-7776e6)}}calculateChange(e){if(e.length<2)return 0;let t=e[e.length-1],a=e[e.length-2];return 0!==a?(t-a)/a*100:0}mapTimeframeToPeriod(e){return"7d"===e?"weekly":"monthly"}generateMockMetrics(e,t){return[{id:"".concat(e,"_referrals_").concat(t),name:"Total Referrals",type:"referrals",value:Math.floor(1e3*Math.random())+100,change:Math.floor(20*Math.random())+5,change_type:"increase",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()},{id:"".concat(e,"_commission_").concat(t),name:"Total Commission",type:"commission",value:Math.floor(1e4*Math.random())+1e3,change:Math.floor(15*Math.random())+3,change_type:"increase",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()},{id:"".concat(e,"_engagement_").concat(t),name:"Active Members",type:"engagement",value:Math.floor(500*Math.random())+50,change:Math.floor(10*Math.random())+2,change_type:"increase",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()},{id:"".concat(e,"_conversion_").concat(t),name:"Conversion Rate",type:"conversion",value:Math.floor(30*Math.random())+10,change:Math.floor(8*Math.random())+1,change_type:"increase",period:this.mapTimeframeToPeriod(t),timestamp:new Date().toISOString()}]}async getMemberDetails(e,t){let{data:a,error:s}=await n.N.from("member_performance_stats").select("*").eq("user_id",e).eq("company_id",t).single();if(s)throw s;let{data:r}=await n.N.from("recent_activity").select("*").eq("user_id",e).order("timestamp",{ascending:!1}).limit(10),{data:i}=await n.N.from("user_quests").select("is_completed, reward_claimed, quest:quests(title, quest_type, difficulty)").eq("user_id",e);return{...a,recent_activity:r||[],quest_stats:{total_quests:(null==i?void 0:i.length)||0,completed_quests:(null==i?void 0:i.filter(e=>e.is_completed).length)||0,claimed_rewards:(null==i?void 0:i.filter(e=>e.reward_claimed).length)||0}}}async generateReport(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"30d",s=this.getTimeframeStartDate(a),r=new Date,i={id:"".concat(e,"_").concat(t,"_").concat(a,"_").concat(Date.now()),company_id:e,report_type:t,timeframe:a,generated_at:r.toISOString(),data:{}};switch(t){case"performance":i.data=await this.generatePerformanceReport(e,s,r);break;case"engagement":i.data=await this.generateEngagementReport(e,s,r);break;case"retention":i.data=await this.generateRetentionReport(e,s,r);break;case"growth":i.data=await this.generateGrowthReport(e,s,r)}let{data:l,error:c}=await n.N.from("report_templates").insert([i]).select().single();if(c)throw c;return l}async generatePerformanceReport(e,t,a){let{data:s}=await n.N.from("member_performance_stats").select("*").eq("company_id",e);return{total_members:(null==s?void 0:s.length)||0,average_commission:(null==s?void 0:s.reduce((e,t)=>e+(t.total_commission||0),0))/((null==s?void 0:s.length)||1),top_performer:null==s?void 0:s.reduce((e,t)=>(t.total_commission||0)>(e.total_commission||0)?t:e,s[0]),performance_distribution:this.calculatePerformanceDistribution(s||[])}}async generateEngagementReport(e,t,a){let{data:s}=await n.N.from("recent_activity").select("*").eq("company_id",e).gte("timestamp",t.toISOString()).lte("timestamp",a.toISOString());return{total_activities:(null==s?void 0:s.length)||0,activity_by_type:this.groupActivityByType(s||[]),peak_activity_times:this.calculatePeakActivityTimes(s||[])}}async generateRetentionReport(e,t,a){let{data:s}=await n.N.from("member_performance_stats").select("*").eq("company_id",e);return{retention_rate:s&&s.length>0?s.reduce((e,t)=>e+("retention_rate"in t&&t.retention_rate||0),0)/s.length:0,churn_rate:s&&s.length>0?s.filter(e=>"retention_rate"in e&&50>(e.retention_rate||0)).length/s.length*100:0,average_lifespan:s&&s.length>0?s.reduce((e,t)=>e+("join_date"in t?new Date().getTime()-new Date(t.join_date).getTime():0),0)/s.length/864e5:0}}async generateGrowthReport(e,t,a){let{data:s}=await n.N.from("referrals").select("*").eq("company_id",e).gte("created_at",t.toISOString()).lte("created_at",a.toISOString()),{data:r}=await n.N.from("user_profiles").select("*").eq("company_id",e).gte("created_at",t.toISOString()).lte("created_at",a.toISOString());return{new_referrals:(null==s?void 0:s.length)||0,new_members:(null==r?void 0:r.length)||0,growth_rate:(null==r?void 0:r.length)?((null==r?void 0:r.length)||0)/((null==r?void 0:r.length)||1)*100:0,referral_sources:this.groupReferralsBySource(s||[])}}calculatePerformanceDistribution(e){return[{min:0,max:100,label:"$0-$100"},{min:101,max:500,label:"$101-$500"},{min:501,max:1e3,label:"$501-$1000"},{min:1001,max:1/0,label:"$1000+"}].map(t=>({range:t.label,count:e.filter(e=>(e.total_commission||0)>=t.min&&(e.total_commission||0)<=t.max).length,percentage:e.filter(e=>(e.total_commission||0)>=t.min&&(e.total_commission||0)<=t.max).length/e.length*100}))}groupActivityByType(e){return Object.entries(e.reduce((e,t)=>(e[t.action]=(e[t.action]||0)+1,e),{})).map(e=>{let[t,a]=e;return{type:t,count:a}})}calculatePeakActivityTimes(e){let t=Array(24).fill(0);return e.forEach(e=>{let a=new Date(e.timestamp).getHours();t[a]++}),t.map((e,t)=>({hour:t,count:e}))}groupReferralsBySource(e){return Object.entries(e.reduce((e,t)=>(e[t.source||"unknown"]=(e[t.source||"unknown"]||0)+1,e),{})).map(e=>{let[t,a]=e;return{source:t,count:a}})}constructor(){this.cache=new Map,this.CACHE_DURATION=3e5}}function l(e){let{companyId:t}=e,[a,n]=(0,r.useState)(null),[l,c]=(0,r.useState)(!0),[o,d]=(0,r.useState)(null),[m,g]=(0,r.useState)("30d"),[h,x]=(0,r.useState)(["referrals","commission"]),u=new i;(0,r.useEffect)(()=>{p()},[t,m]);let p=async()=>{try{c(!0);let e=await u.getDashboardData(t,m);n(e),d(null)}catch(e){console.error("Error fetching dashboard data:",e),d("Failed to load analytics data")}finally{c(!1)}},y=async()=>{await p()},v=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),f=e=>new Intl.NumberFormat("en-US").format(e),b=e=>"".concat(e.toFixed(1),"%"),_=e=>({referrals:"\uD83D\uDC65",commission:"\uD83D\uDCB0",engagement:"\uD83D\uDCCA",retention:"\uD83D\uDD04",conversion:"\uD83C\uDFAF",growth:"\uD83D\uDCC8"})[e]||"\uD83D\uDCCA",j=(e,t)=>"increase"===t?e>0?"text-green-600":"text-red-600":e>0?"text-red-600":"text-green-600",w=e=>({trend:"\uD83D\uDCC8",opportunity:"\uD83D\uDCA1",warning:"⚠️",achievement:"\uD83C\uDFC6",recommendation:"\uD83C\uDFAF"})[e]||"\uD83D\uDCA1",N=e=>({trend:"border-blue-200 bg-blue-50",opportunity:"border-green-200 bg-green-50",warning:"border-yellow-200 bg-yellow-50",achievement:"border-purple-200 bg-purple-50",recommendation:"border-indigo-200 bg-indigo-50"})[e]||"border-gray-200 bg-gray-50";return l?(0,s.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):o?(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[(0,s.jsx)("p",{className:"text-red-800",children:o}),(0,s.jsx)("button",{onClick:y,className:"mt-2 text-red-600 hover:text-red-800 underline",children:"Try again"})]}):a?(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Analytics Dashboard"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Track your community's performance and growth"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsxs)("select",{value:m,onChange:e=>g(e.target.value),className:"border border-gray-300 rounded-lg px-3 py-2 text-sm",children:[(0,s.jsx)("option",{value:"7d",children:"Last 7 days"}),(0,s.jsx)("option",{value:"30d",children:"Last 30 days"}),(0,s.jsx)("option",{value:"90d",children:"Last 90 days"})]}),(0,s.jsx)("button",{onClick:y,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"Refresh"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 bg-blue-100 rounded-lg",children:(0,s.jsx)("span",{className:"text-2xl",children:"\uD83D\uDC65"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Total Members"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:f(a.overview.total_members)}),(0,s.jsxs)("p",{className:"text-sm ".concat(a.overview.member_growth_rate>=0?"text-green-600":"text-red-600"),children:[a.overview.member_growth_rate>=0?"↑":"↓"," ",Math.abs(a.overview.member_growth_rate).toFixed(1),"%"]})]})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 bg-green-100 rounded-lg",children:(0,s.jsx)("span",{className:"text-2xl",children:"\uD83D\uDCB0"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Total Commission"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:v(a.overview.total_commission)}),(0,s.jsxs)("p",{className:"text-sm ".concat(a.overview.revenue_growth_rate>=0?"text-green-600":"text-red-600"),children:[a.overview.revenue_growth_rate>=0?"↑":"↓"," ",Math.abs(a.overview.revenue_growth_rate).toFixed(1),"%"]})]})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 bg-purple-100 rounded-lg",children:(0,s.jsx)("span",{className:"text-2xl",children:"\uD83C\uDFAF"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Active Members"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:f(a.overview.active_members)}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:[b(a.overview.active_members/a.overview.total_members*100)," active"]})]})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"p-3 bg-yellow-100 rounded-lg",children:(0,s.jsx)("span",{className:"text-2xl",children:"\uD83D\uDCC8"})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Conversion Rate"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:b(a.overview.average_conversion_rate)}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Average rate"})]})]})})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,s.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Performance Metrics"})}),(0,s.jsx)("div",{className:"p-6",children:(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:a.metrics.map(e=>(0,s.jsxs)("div",{className:"border border-gray-200 rounded-lg p-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsx)("span",{className:"text-2xl",children:_(e.type)}),(0,s.jsxs)("span",{className:"text-sm font-medium ".concat(j(e.change,e.change_type)),children:["increase"===e.change_type?"↑":"↓"," ",e.change.toFixed(1),"%"]})]}),(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:e.name}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:"commission"===e.type?v(e.value):f(e.value)}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:e.period})]},e.id))})})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,s.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Top Performers"})}),(0,s.jsx)("div",{className:"p-6",children:(0,s.jsx)("div",{className:"space-y-4",children:a.top_performers.slice(0,5).map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 bg-gray-50 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsxs)("div",{className:"text-lg font-bold text-gray-500",children:["#",t+1]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:e.username}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:[e.character_class," • Level ",e.level]})]})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsx)("p",{className:"font-medium text-gray-900",children:v(e.total_commission)}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:[f(e.total_referrals)," referrals"]})]})]},e.id))})})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,s.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Recent Activity"})}),(0,s.jsx)("div",{className:"p-6",children:(0,s.jsx)("div",{className:"space-y-3",children:a.recent_activity.slice(0,10).map(e=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-gray-900",children:e.username}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:e.action})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e.action.includes("commission")?v(e.value):f(e.value)}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:new Date(e.timestamp).toLocaleString()})]})]},e.id))})})]}),a.insights.length>0&&(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,s.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Insights & Recommendations"})}),(0,s.jsx)("div",{className:"p-6",children:(0,s.jsx)("div",{className:"space-y-4",children:a.insights.slice(0,3).map(e=>(0,s.jsx)("div",{className:"border-l-4 p-4 rounded-lg ".concat(N(e.type)),children:(0,s.jsxs)("div",{className:"flex items-start space-x-3",children:[(0,s.jsx)("span",{className:"text-2xl",children:w(e.type)}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:e.title}),(0,s.jsx)("span",{className:"text-xs px-2 py-1 rounded-full ".concat("high"===e.priority?"bg-red-100 text-red-800":"medium"===e.priority?"bg-yellow-100 text-yellow-800":"bg-blue-100 text-blue-800"),children:e.priority})]}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:e.description}),e.actionable&&(0,s.jsx)("button",{className:"mt-2 text-sm text-blue-600 hover:text-blue-800",children:"View Details →"})]})]})},e.id))})})]})]}):(0,s.jsx)("div",{children:"No data available"})}class c{async searchMembers(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=n.N.from("member_performance_stats").select("\n        user_id,\n        username,\n        avatar,\n        character_class,\n        level,\n        total_referrals,\n        total_commission,\n        conversion_rate,\n        engagement_score,\n        retention_rate,\n        quest_completion_rate,\n        last_active,\n        join_date,\n        is_active\n      ",{count:"exact"}).eq("company_id",e);t.search&&(s=s.ilike("username","%".concat(t.search,"%"))),t.character_class&&"all"!==t.character_class&&(s=s.eq("character_class",t.character_class)),t.level_range&&(s=s.gte("level",t.level_range[0]).lte("level",t.level_range[1])),t.commission_range&&(s=s.gte("total_commission",t.commission_range[0]).lte("total_commission",t.commission_range[1])),t.referral_range&&(s=s.gte("total_referrals",t.referral_range[0]).lte("total_referrals",t.referral_range[1])),t.status&&"all"!==t.status&&(s=s.eq("is_active","active"===t.status)),t.join_date_range&&(s=s.gte("join_date",t.join_date_range[0]).lte("join_date",t.join_date_range[1]));let r=t.sort_by||"total_commission",i=t.sort_order||"desc";s=s.order(r,{ascending:"asc"===i});let l=(a-1)*this.PAGE_SIZE;s=s.range(l,l+this.PAGE_SIZE-1);let{data:c,error:o,count:d}=await s;if(o)throw o;return{members:await Promise.all((c||[]).map(async(t,a)=>({id:t.user_id,user_id:t.user_id,username:t.username,avatar:t.avatar,character_class:t.character_class,level:t.level||1,total_referrals:t.total_referrals||0,total_commission:t.total_commission||0,conversion_rate:t.conversion_rate||0,engagement_score:t.engagement_score||0,retention_rate:t.retention_rate||0,quest_completion_rate:t.quest_completion_rate||0,last_active:t.last_active,join_date:t.join_date,is_active:t.is_active,rank:l+a+1,badges:await this.getMemberBadges(t.user_id,e)}))),total:d||0,page:a,pages:Math.ceil((d||0)/this.PAGE_SIZE)}}async getMemberDetails(e,t){let{data:a,error:s}=await n.N.from("member_performance_stats").select("*").eq("user_id",e).eq("company_id",t).single();if(s)return null;let r=await this.getMemberBadges(e,t);return{id:a.user_id,user_id:a.user_id,username:a.username,avatar:a.avatar,character_class:a.character_class,level:a.level||1,total_referrals:a.total_referrals||0,total_commission:a.total_commission||0,conversion_rate:a.conversion_rate||0,engagement_score:a.engagement_score||0,retention_rate:a.retention_rate||0,quest_completion_rate:a.quest_completion_rate||0,last_active:a.last_active,join_date:a.join_date,is_active:a.is_active,rank:await this.getMemberRank(e,t),badges:r}}async getMemberAnalytics(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"30d",s=this.getTimeframeStartDate(a),{data:r}=await n.N.from("referrals").select("*").eq("referrer_id",e).eq("company_id",t).gte("created_at",s.toISOString()).order("created_at",{ascending:!1}),{data:i}=await n.N.from("user_quests").select("\n        *,\n        quest:quests (\n          title,\n          quest_type,\n          difficulty,\n          reward_xp,\n          reward_commission\n        )\n      ").eq("user_id",e).gte("created_at",s.toISOString()).order("created_at",{ascending:!1}),{data:l}=await n.N.from("daily_member_stats").select("*").eq("user_id",e).eq("company_id",t).gte("date",s.toISOString()).order("date",{ascending:!1});return{referrals:r||[],quests:i||[],daily_stats:l||[],summary:{total_referrals:(null==r?void 0:r.length)||0,converted_referrals:(null==r?void 0:r.filter(e=>e.converted_at).length)||0,total_commission:(null==r?void 0:r.reduce((e,t)=>e+(t.commission_amount||0),0))||0,completed_quests:(null==i?void 0:i.filter(e=>e.is_completed).length)||0,claimed_rewards:(null==i?void 0:i.filter(e=>e.reward_claimed).length)||0}}}async exportMembers(e,t){let{members:a}=await this.searchMembers(e,t.filters,1);switch(t.format){case"csv":case"xlsx":return this.exportToCSV(a,t.fields);case"json":return this.exportToJSON(a,t.fields);default:throw Error("Unsupported export format: ".concat(t.format))}}async getMemberRank(e,t){let{data:a,error:s}=await n.N.from("member_performance_stats").select("user_id, total_commission",{count:"exact"}).eq("company_id",t).gt("total_commission",n.N.from("member_performance_stats").select("total_commission").eq("user_id",e).single());if(s)throw s;return((null==a?void 0:a.length)||0)+1}async getMemberBadges(e,t){let{data:a}=await n.N.from("user_achievements").select("achievement:achievements (badge_icon)").eq("user_id",e).eq("company_id",t);return(a||[]).map(e=>{var t;return(null==(t=e.achievement)?void 0:t.badge_icon)||"\uD83C\uDFC6"}).slice(0,5)}async getMemberStats(e){let{data:t,error:a}=await n.N.from("member_performance_stats").select("*").eq("company_id",e);if(a)throw a;let s=(null==t?void 0:t.length)||0,r=(null==t?void 0:t.filter(e=>e.is_active).length)||0,i=(null==t?void 0:t.reduce((e,t)=>e+(t.level||0),0))/((null==t?void 0:t.length)||1),l=(null==t?void 0:t.reduce((e,t)=>e+(t.total_commission||0),0))||0,c=Object.entries(null==t?void 0:t.reduce((e,t)=>(e[t.character_class]=(e[t.character_class]||0)+1,e),{})).reduce((e,t)=>{let[a,s]=t;return s>e.count?{class:a,count:s}:e},{class:"",count:0}).class,o=new Date;return o.setDate(1),{total_members:s,active_members:r,average_level:Math.round(10*i)/10,total_commission:l,top_character_class:c,new_members_this_month:(null==t?void 0:t.filter(e=>new Date(e.join_date)>=o).length)||0}}async bulkUpdateMembers(e,t){let a=t.map(async t=>{let{user_id:a,updates:s}=t,{error:r}=await n.N.from("member_performance_stats").update(s).eq("user_id",a).eq("company_id",e);if(r)throw r});await Promise.all(a)}async getMemberActivityTimeline(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,{data:s}=await n.N.from("recent_activity").select("*").eq("user_id",e).eq("company_id",t).order("timestamp",{ascending:!1}).limit(a);return(s||[]).map(e=>({id:e.id,type:e.action,title:this.getActivityTitle(e.action),description:e.description||"",value:e.value,timestamp:e.timestamp,metadata:e.metadata||{}}))}getActivityTitle(e){return({referral_created:"New Referral",referral_converted:"Referral Converted",quest_completed:"Quest Completed",reward_claimed:"Reward Claimed",level_up:"Level Up",achievement_unlocked:"Achievement Unlocked",commission_earned:"Commission Earned"})[e]||"Activity"}getTimeframeStartDate(e){let t=new Date;switch(e){case"7d":return new Date(t.getTime()-6048e5);case"30d":default:return new Date(t.getTime()-2592e6);case"90d":return new Date(t.getTime()-7776e6)}}exportToCSV(e,t){return[t.join(","),...e.map(e=>t.map(t=>{let a=e[t];return"string"==typeof a?'"'.concat(a,'"'):a}).join(","))].join("\n")}exportToJSON(e,t){return JSON.stringify(e.map(e=>{let a={};return t.forEach(t=>{a[t]=e[t]}),a}),null,2)}constructor(){this.PAGE_SIZE=20}}function o(e){let{companyId:t}=e,[a,n]=(0,r.useState)([]),[i,l]=(0,r.useState)(!0),[o,d]=(0,r.useState)(null),[m,g]=(0,r.useState)(1),[h,x]=(0,r.useState)(0),[u,p]=(0,r.useState)(1),[y,v]=(0,r.useState)(null),[f,b]=(0,r.useState)(!1),[_,j]=(0,r.useState)({sort_by:"total_commission",sort_order:"desc",status:"all"}),w=new c;(0,r.useEffect)(()=>{N()},[t,m,_]);let N=async()=>{try{l(!0);let e=await w.searchMembers(t,_,m);n(e.members),x(e.total),p(e.pages),d(null)}catch(e){console.error("Error fetching members:",e),d("Failed to load members")}finally{l(!1)}},S=(e,t)=>{j(a=>({...a,[e]:t})),g(1)},C=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"csv";try{let a=await w.exportMembers(t,{format:e,fields:["username","character_class","level","total_referrals","total_commission","conversion_rate","engagement_score"],filters:_}),s=new Blob([a],{type:"csv"===e?"text/csv":"application/json"}),r=URL.createObjectURL(s),n=document.createElement("a");n.href=r,n.download="members_export_".concat(new Date().toISOString().split("T")[0],".").concat(e),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)}catch(e){console.error("Error exporting members:",e),d("Failed to export members")}},D=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),k=e=>new Intl.NumberFormat("en-US").format(e),T=e=>"".concat(e.toFixed(1),"%"),I=e=>({scout:"\uD83D\uDD0D",sage:"\uD83D\uDCDA",champion:"\uD83C\uDFC6",merchant:"\uD83D\uDCB0"})[e]||"\uD83D\uDC64",M=e=>e>=80?"text-green-600 bg-green-100":e>=60?"text-yellow-600 bg-yellow-100":"text-red-600 bg-red-100";return i&&1===m?(0,s.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):o?(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[(0,s.jsx)("p",{className:"text-red-800",children:o}),(0,s.jsx)("button",{onClick:N,className:"mt-2 text-red-600 hover:text-red-800 underline",children:"Try again"})]}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Member Directory"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Manage and analyze your community members"})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,s.jsx)("button",{onClick:()=>b(!f),className:"border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors",children:f?"Hide Filters":"Show Filters"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)("select",{onChange:e=>C(e.target.value),className:"border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors appearance-none pr-8",children:[(0,s.jsx)("option",{value:"",children:"Export"}),(0,s.jsx)("option",{value:"csv",children:"Export as CSV"}),(0,s.jsx)("option",{value:"json",children:"Export as JSON"})]}),(0,s.jsx)("div",{className:"absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none",children:(0,s.jsx)("span",{className:"text-gray-500",children:"↓"})})]})]})]}),f&&(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Search"}),(0,s.jsx)("input",{type:"text",placeholder:"Search members...",value:_.search||"",onChange:e=>S("search",e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Character Class"}),(0,s.jsxs)("select",{value:_.character_class||"",onChange:e=>S("character_class",e.target.value||void 0),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"",children:"All Classes"}),(0,s.jsx)("option",{value:"scout",children:"Scout"}),(0,s.jsx)("option",{value:"sage",children:"Sage"}),(0,s.jsx)("option",{value:"champion",children:"Champion"}),(0,s.jsx)("option",{value:"merchant",children:"Merchant"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),(0,s.jsxs)("select",{value:_.status||"all",onChange:e=>S("status",e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"all",children:"All Members"}),(0,s.jsx)("option",{value:"active",children:"Active"}),(0,s.jsx)("option",{value:"inactive",children:"Inactive"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Sort By"}),(0,s.jsxs)("select",{value:_.sort_by||"total_commission",onChange:e=>S("sort_by",e.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"total_commission",children:"Commission"}),(0,s.jsx)("option",{value:"total_referrals",children:"Referrals"}),(0,s.jsx)("option",{value:"level",children:"Level"}),(0,s.jsx)("option",{value:"engagement_score",children:"Engagement"}),(0,s.jsx)("option",{value:"last_active",children:"Last Active"})]})]})]}),(0,s.jsxs)("div",{className:"flex justify-end mt-4 space-x-4",children:[(0,s.jsx)("button",{onClick:()=>{j({sort_by:"total_commission",sort_order:"desc",status:"all"}),g(1)},className:"text-gray-600 hover:text-gray-800 px-4 py-2",children:"Clear Filters"}),(0,s.jsx)("button",{onClick:N,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"Apply Filters"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"\uD83D\uDC65"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Total Members"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:k(h)})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"\uD83D\uDCB0"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Avg Commission"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:D(a.reduce((e,t)=>e+t.total_commission,0)/(a.length||1))})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"\uD83C\uDFAF"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Avg Conversion"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:T(a.reduce((e,t)=>e+t.conversion_rate,0)/(a.length||1))})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"\uD83D\uDCCA"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Avg Engagement"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:T(a.reduce((e,t)=>e+t.engagement_score,0)/(a.length||1))})]})})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:[(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"min-w-full divide-y divide-gray-200",children:[(0,s.jsx)("thead",{className:"bg-gray-50",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Member"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Class & Level"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Performance"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Engagement"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Last Active"}),(0,s.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),(0,s.jsx)("tbody",{className:"bg-white divide-y divide-gray-200",children:a.map(e=>(0,s.jsxs)("tr",{className:"hover:bg-gray-50",children:[(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"flex-shrink-0 h-10 w-10",children:e.avatar?(0,s.jsx)("img",{className:"h-10 w-10 rounded-full",src:e.avatar,alt:""}):(0,s.jsx)("div",{className:"h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center",children:(0,s.jsx)("span",{className:"text-gray-600 font-medium",children:e.username.charAt(0).toUpperCase()})})}),(0,s.jsxs)("div",{className:"ml-4",children:[(0,s.jsx)("div",{className:"text-sm font-medium text-gray-900",children:e.username}),(0,s.jsxs)("div",{className:"text-sm text-gray-500",children:["Rank #",e.rank]})]})]})}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("span",{className:"text-lg mr-2",children:I(e.character_class)}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-sm font-medium text-gray-900 capitalize",children:e.character_class}),(0,s.jsxs)("div",{className:"text-sm text-gray-500",children:["Level ",e.level]})]})]})}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,s.jsxs)("div",{className:"text-sm text-gray-900",children:[(0,s.jsx)("div",{children:D(e.total_commission)}),(0,s.jsxs)("div",{className:"text-xs text-gray-500",children:[k(e.total_referrals)," referrals"]})]})}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(M(e.engagement_score)),children:T(e.engagement_score)}),(0,s.jsxs)("div",{className:"text-xs text-gray-500",children:[T(e.conversion_rate)," conv"]})]})}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:new Date(e.last_active).toLocaleDateString()}),(0,s.jsx)("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:(0,s.jsx)("button",{onClick:()=>v(e),className:"text-blue-600 hover:text-blue-900",children:"View Details"})})]},e.id))})]})}),(0,s.jsxs)("div",{className:"bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6",children:[(0,s.jsxs)("div",{className:"flex-1 flex justify-between sm:hidden",children:[(0,s.jsx)("button",{onClick:()=>g(Math.max(1,m-1)),disabled:1===m,className:"relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50",children:"Previous"}),(0,s.jsx)("button",{onClick:()=>g(Math.min(u,m+1)),disabled:m===u,className:"ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50",children:"Next"})]}),(0,s.jsxs)("div",{className:"hidden sm:flex-1 sm:flex sm:items-center sm:justify-between",children:[(0,s.jsx)("div",{children:(0,s.jsxs)("p",{className:"text-sm text-gray-700",children:["Showing ",(0,s.jsx)("span",{className:"font-medium",children:(m-1)*20+1})," to"," ",(0,s.jsx)("span",{className:"font-medium",children:Math.min(20*m,h)})," ","of ",(0,s.jsx)("span",{className:"font-medium",children:k(h)})," results"]})}),(0,s.jsx)("div",{children:(0,s.jsxs)("nav",{className:"relative z-0 inline-flex rounded-md shadow-sm -space-x-px",children:[(0,s.jsx)("button",{onClick:()=>g(Math.max(1,m-1)),disabled:1===m,className:"relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50",children:"Previous"}),Array.from({length:Math.min(5,u)},(e,t)=>{let a=Math.max(1,Math.min(u-4,m-2))+t;return(0,s.jsx)("button",{onClick:()=>g(a),className:"relative inline-flex items-center px-4 py-2 border text-sm font-medium ".concat(m===a?"z-10 bg-blue-50 border-blue-500 text-blue-600":"bg-white border-gray-300 text-gray-500 hover:bg-gray-50"),children:a},a)}),(0,s.jsx)("button",{onClick:()=>g(Math.min(u,m+1)),disabled:m===u,className:"relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50",children:"Next"})]})})]})]})]}),y&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsx)("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-bold text-gray-900",children:y.username}),(0,s.jsx)("p",{className:"text-gray-600",children:"Member Details"})]}),(0,s.jsx)("button",{onClick:()=>v(null),className:"text-gray-400 hover:text-gray-600",children:(0,s.jsx)("span",{className:"text-2xl",children:"\xd7"})})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-semibold text-gray-900 mb-4",children:"Profile"}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Character Class"}),(0,s.jsx)("span",{className:"font-medium",children:y.character_class})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Level"}),(0,s.jsx)("span",{className:"font-medium",children:y.level})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Rank"}),(0,s.jsxs)("span",{className:"font-medium",children:["#",y.rank]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Status"}),(0,s.jsx)("span",{className:"font-medium ".concat(y.is_active?"text-green-600":"text-red-600"),children:y.is_active?"Active":"Inactive"})]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-semibold text-gray-900 mb-4",children:"Performance"}),(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Total Commission"}),(0,s.jsx)("span",{className:"font-medium",children:D(y.total_commission)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Total Referrals"}),(0,s.jsx)("span",{className:"font-medium",children:k(y.total_referrals)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Conversion Rate"}),(0,s.jsx)("span",{className:"font-medium",children:T(y.conversion_rate)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Engagement Score"}),(0,s.jsx)("span",{className:"font-medium",children:T(y.engagement_score)})]})]})]})]}),(0,s.jsxs)("div",{className:"mt-6",children:[(0,s.jsx)("h4",{className:"font-semibold text-gray-900 mb-4",children:"Badges"}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[y.badges.map((e,t)=>(0,s.jsx)("span",{className:"text-2xl",children:e},t)),0===y.badges.length&&(0,s.jsx)("span",{className:"text-gray-500",children:"No badges earned yet"})]})]}),(0,s.jsxs)("div",{className:"mt-6 flex justify-end space-x-4",children:[(0,s.jsx)("button",{onClick:()=>v(null),className:"px-4 py-2 text-gray-700 hover:text-gray-900",children:"Close"}),(0,s.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"View Full Profile"})]})]})})})]})}function d(e){let{companyId:t}=e,[a,n]=(0,r.useState)([]),[l,c]=(0,r.useState)(null),[o,d]=(0,r.useState)(!1),[m,g]=(0,r.useState)(!0),[h,x]=(0,r.useState)(null);new i;let u=[{id:"performance_summary",name:"Performance Summary",description:"Comprehensive overview of member performance metrics",type:"performance",timeframe:"30d",lastGenerated:null},{id:"engagement_analysis",name:"Engagement Analysis",description:"Deep dive into member engagement and activity patterns",type:"engagement",timeframe:"30d",lastGenerated:null},{id:"retention_report",name:"Retention Report",description:"Member retention and churn analysis",type:"retention",timeframe:"90d",lastGenerated:null},{id:"growth_analysis",name:"Growth Analysis",description:"Community growth and expansion metrics",type:"growth",timeframe:"30d",lastGenerated:null},{id:"weekly_summary",name:"Weekly Summary",description:"Weekly performance and activity summary",type:"performance",timeframe:"7d",lastGenerated:null}];(0,r.useEffect)(()=>{p()},[t]);let p=async()=>{try{g(!0);let e=await fetch("/api/reports/generate?companyId=".concat(t));if(e.ok){let t=await e.json(),a=u.map(e=>{let a=t.find(t=>t.report_type===e.type);return{...e,lastGenerated:(null==a?void 0:a.generated_at)||null}});n(a)}x(null)}catch(e){console.error("Error fetching reports:",e),x("Failed to load reports")}finally{g(!1)}},y=async e=>{try{d(!0),c(e);let a=await fetch("/api/reports/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:t,reportType:e.type,timeframe:e.timeframe})});if(a.ok){let e=await a.json();console.log("Report generated:",e),await p()}else x("Failed to generate report")}catch(e){console.error("Error generating report:",e),x("Failed to generate report")}finally{d(!1),c(null)}},v=async e=>{try{let a=await fetch("/api/reports/generate?companyId=".concat(t,"&reportType=").concat(e.type));if(a.ok){let t=await a.json(),s=JSON.stringify(t,null,2),r="data:application/json;charset=utf-8,"+encodeURIComponent(s),n="".concat(e.name,"_").concat(new Date().toISOString().split("T")[0],".json"),i=document.createElement("a");i.setAttribute("href",r),i.setAttribute("download",n),i.click()}}catch(e){console.error("Error downloading report:",e),x("Failed to download report")}},f=e=>{switch(e){case"7d":return"Last 7 days";case"30d":return"Last 30 days";case"90d":return"Last 90 days";default:return e}},b=e=>e?new Date(e).toLocaleDateString():"Never",_=e=>({performance:"\uD83D\uDCCA",engagement:"\uD83D\uDCAC",retention:"\uD83D\uDD04",growth:"\uD83D\uDCC8"})[e]||"\uD83D\uDCC4",j=e=>({performance:"border-blue-200 bg-blue-50",engagement:"border-green-200 bg-green-50",retention:"border-yellow-200 bg-yellow-50",growth:"border-purple-200 bg-purple-50"})[e]||"border-gray-200 bg-gray-50";return m?(0,s.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):h?(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,s.jsx)("p",{className:"text-red-800",children:h})}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Report Builder"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Generate and download detailed analytics reports"})]}),(0,s.jsx)("button",{onClick:p,className:"border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors",children:"Refresh"})]}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(e=>(0,s.jsxs)("div",{className:"border-2 rounded-lg p-6 ".concat(j(e.type)," hover:shadow-md transition-shadow"),children:[(0,s.jsx)("div",{className:"flex items-start justify-between mb-4",children:(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsx)("span",{className:"text-3xl",children:_(e.type)}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:e.name}),(0,s.jsx)("p",{className:"text-sm text-gray-600 capitalize",children:e.type})]})]})}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mb-4",children:e.description}),(0,s.jsxs)("div",{className:"space-y-2 mb-4",children:[(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Timeframe:"}),(0,s.jsx)("span",{className:"font-medium",children:f(e.timeframe)})]}),(0,s.jsxs)("div",{className:"flex justify-between text-sm",children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Last generated:"}),(0,s.jsx)("span",{className:"font-medium",children:b(e.lastGenerated)})]})]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:()=>y(e),disabled:o&&(null==l?void 0:l.id)===e.id,className:"flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:o&&(null==l?void 0:l.id)===e.id?(0,s.jsxs)("span",{className:"flex items-center justify-center",children:[(0,s.jsx)("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Generating..."]}):"Generate Report"}),e.lastGenerated&&(0,s.jsx)("button",{onClick:()=>v(e),className:"px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm",children:"Download"})]})]},e.id))}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Custom Report Builder"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Report Type"}),(0,s.jsxs)("select",{className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"performance",children:"Performance"}),(0,s.jsx)("option",{value:"engagement",children:"Engagement"}),(0,s.jsx)("option",{value:"retention",children:"Retention"}),(0,s.jsx)("option",{value:"growth",children:"Growth"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Timeframe"}),(0,s.jsxs)("select",{className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"7d",children:"Last 7 days"}),(0,s.jsx)("option",{value:"30d",children:"Last 30 days"}),(0,s.jsx)("option",{value:"90d",children:"Last 90 days"}),(0,s.jsx)("option",{value:"custom",children:"Custom Range"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Format"}),(0,s.jsxs)("select",{className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"json",children:"JSON"}),(0,s.jsx)("option",{value:"csv",children:"CSV"}),(0,s.jsx)("option",{value:"pdf",children:"PDF"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Schedule"}),(0,s.jsxs)("select",{className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"once",children:"Generate Once"}),(0,s.jsx)("option",{value:"daily",children:"Daily"}),(0,s.jsx)("option",{value:"weekly",children:"Weekly"}),(0,s.jsx)("option",{value:"monthly",children:"Monthly"})]})]})]}),(0,s.jsx)("div",{className:"mt-4 flex justify-end",children:(0,s.jsx)("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"Create Custom Report"})})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,s.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Recent Reports"})}),(0,s.jsx)("div",{className:"p-6",children:(0,s.jsxs)("div",{className:"space-y-3",children:[a.filter(e=>e.lastGenerated).sort((e,t)=>new Date(t.lastGenerated).getTime()-new Date(e.lastGenerated).getTime()).slice(0,5).map(e=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsx)("span",{className:"text-xl",children:_(e.type)}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium text-gray-900",children:e.name}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Generated on ",b(e.lastGenerated)]})]})]}),(0,s.jsx)("button",{onClick:()=>v(e),className:"text-blue-600 hover:text-blue-800 text-sm",children:"Download"})]},e.id)),0===a.filter(e=>e.lastGenerated).length&&(0,s.jsx)("p",{className:"text-center text-gray-500 py-4",children:"No reports generated yet. Create your first report above."})]})})]})]})}class m{initializeDefaultConfigs(){this.addConfig({id:"low_conversion_rate",name:"Low Conversion Rate",description:"Detect when conversion rate drops below threshold",type:"warning",category:"performance",conditions:[{field:"conversion_rate",operator:"lt",value:20,weight:.8}],actions:[{type:"notification",target:"creator",template:"Conversion rate is below 20%. Consider reviewing referral strategies."}],priority:"high",enabled:!0}),this.addConfig({id:"high_performer",name:"High Performer Detected",description:"Identify members with exceptional performance",type:"achievement",category:"performance",conditions:[{field:"total_commission",operator:"gt",value:5e3,weight:.7},{field:"conversion_rate",operator:"gt",value:50,weight:.3}],actions:[{type:"notification",target:"both",template:"Exceptional performance detected!"},{type:"badge",target:"member",template:"top_performer"}],priority:"medium",enabled:!0}),this.addConfig({id:"declining_engagement",name:"Declining Member Engagement",description:"Detect when member engagement is decreasing",type:"warning",category:"engagement",conditions:[{field:"engagement_score",operator:"lt",value:40,weight:.6},{field:"engagement_trend",operator:"lt",value:-10,weight:.4}],actions:[{type:"notification",target:"creator",template:"Member engagement is declining. Consider engagement campaigns."},{type:"quest",target:"member",template:"engagement_boost"}],priority:"high",enabled:!0}),this.addConfig({id:"high_activity_member",name:"High Activity Member",description:"Identify members with consistently high activity",type:"achievement",category:"engagement",conditions:[{field:"engagement_score",operator:"gt",value:80,weight:.5},{field:"quest_completion_rate",operator:"gt",value:70,weight:.3},{field:"active_days_count",operator:"gt",value:20,weight:.2}],actions:[{type:"badge",target:"member",template:"engagement_champion"}],priority:"low",enabled:!0}),this.addConfig({id:"churn_risk",name:"Churn Risk Detected",description:"Identify members at risk of churning",type:"warning",category:"retention",conditions:[{field:"days_since_last_activity",operator:"gt",value:30,weight:.4},{field:"engagement_score",operator:"lt",value:30,weight:.3},{field:"retention_rate",operator:"lt",value:50,weight:.3}],actions:[{type:"notification",target:"creator",template:"Members at risk of churn detected."},{type:"message",target:"member",template:"reactivation_campaign"}],priority:"critical",enabled:!0}),this.addConfig({id:"rapid_growth",name:"Rapid Growth Detected",description:"Detect when growth rate exceeds expectations",type:"opportunity",category:"growth",conditions:[{field:"member_growth_rate",operator:"gt",value:50,weight:.6},{field:"new_members_count",operator:"gt",value:100,weight:.4}],actions:[{type:"notification",target:"creator",template:"Exceptional growth rate detected!"}],priority:"medium",enabled:!0}),this.addConfig({id:"revenue_anomaly",name:"Revenue Anomaly Detected",description:"Detect unusual revenue patterns",type:"warning",category:"revenue",conditions:[{field:"revenue_change_percent",operator:"lt",value:-20,weight:.5},{field:"revenue_volatility",operator:"gt",value:30,weight:.5}],actions:[{type:"notification",target:"creator",template:"Unusual revenue pattern detected. Review recent changes."}],priority:"high",enabled:!0})}addConfig(e){this.configs.set(e.id,e)}async generateInsights(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"30d",a="insights_".concat(e,"_").concat(t),s=this.cache.get(a);if(s&&s[0]){let e=s[0].created_at;if((e?Date.now()-new Date(e).getTime():0)<this.CACHE_DURATION)return s}let r=[],n=await this.getCompanyData(e,t);for(let[t,a]of this.configs.entries()){if(!a.enabled)continue;let t=await this.evaluateConfig(a,n,e);r.push(...t)}return await this.saveInsights(r),this.cache.set(a,r),r}async getCompanyData(e,t){let a=this.getTimeframeStartDate(t),{data:s}=await n.N.from("member_performance_stats").select("*").eq("company_id",e),{data:r}=await n.N.from("recent_activity").select("*").eq("company_id",e).gte("timestamp",a.toISOString()),{data:i}=await n.N.from("analytics_aggregations").select("*").eq("company_id",e).gte("date",a.toISOString()),l=(null==s?void 0:s.length)||0,c=(null==s?void 0:s.filter(e=>e.is_active).length)||0,o=(null==s?void 0:s.reduce((e,t)=>e+(t.total_commission||0),0))||0,d=(null==s?void 0:s.reduce((e,t)=>e+(t.total_referrals||0),0))||0,m=(null==s?void 0:s.reduce((e,t)=>e+(t.conversion_rate||0),0))/((null==s?void 0:s.length)||1)||0,g=(null==s?void 0:s.reduce((e,t)=>e+(t.engagement_score||0),0))/((null==s?void 0:s.length)||1)||0,h=i||[],x=this.calculateTrend(h.map(e=>e.total_commission||0)),u=this.calculateTrend(h.map(e=>e.active_users||0));return{members:s||[],activity:r||[],analytics:h,aggregated:{total_members:l,active_members:c,total_commission:o,total_referrals:d,average_conversion_rate:m,average_engagement_score:g,revenue_growth_rate:x,member_growth_rate:u,timeframe:t}}}async evaluateConfig(e,t,a){let s=[];for(let r of t.members){let n={...t.aggregated,...r,company_data:t};if(await this.evaluateConditions(e.conditions,n)){let t=await this.createInsight(e,n,a,r.user_id);s.push(t)}}let r={...t.aggregated,company_data:t};if(await this.evaluateConditions(e.conditions.filter(e=>!e.field.startsWith("member_")),r)){let t=await this.createInsight(e,r,a);s.push(t)}return s}async evaluateConditions(e,t){if(0===e.length)return!0;let a=0,s=0;for(let r of e){let e=r.weight||1;a+=e,await this.evaluateCondition(r,t)&&(s+=e)}return a>0&&s/a>=.7}async evaluateCondition(e,t){let a=this.getFieldValue(e.field,t);switch(e.operator){case"gt":return a>e.value;case"lt":return a<e.value;case"eq":return a===e.value;case"gte":return a>=e.value;case"lte":return a<=e.value;case"between":return a>=e.value[0]&&a<=e.value[1];case"contains":return String(a).includes(String(e.value));default:return!1}}getFieldValue(e,t){return e.split(".").reduce((e,t)=>null==e?void 0:e[t],t)}async createInsight(e,t,a,s){let r=this.generateInsightTitle(e,t),n=this.generateInsightDescription(e,t);return{id:"".concat(e.id,"_").concat(a,"_").concat(s||"company","_").concat(Date.now()),config_id:e.id,type:e.type,category:e.category,title:r,description:n,data:t,actionable:!0,priority:e.priority,created_at:new Date().toISOString(),acknowledged:!1,company_id:a,user_id:s}}generateInsightTitle(e,t){var a,s,r;return({low_conversion_rate:"Low conversion rate detected (".concat(null==(a=t.average_conversion_rate)?void 0:a.toFixed(1),"%)"),high_performer:"High performer: ".concat(t.username," (").concat(null==(s=t.total_commission)?void 0:s.toLocaleString(),")"),declining_engagement:"Declining engagement detected",high_activity_member:"High activity member: ".concat(t.username),churn_risk:"Churn risk: ".concat(t.username),rapid_growth:"Rapid growth: ".concat(null==(r=t.member_growth_rate)?void 0:r.toFixed(1),"% increase"),revenue_anomaly:"Revenue anomaly detected"})[e.id]||e.name}generateInsightDescription(e,t){var a,s,r,n,i,l,c;return({low_conversion_rate:"The average conversion rate is ".concat(null==(a=t.average_conversion_rate)?void 0:a.toFixed(1),"%, which is below the healthy threshold of 20%."),high_performer:"".concat(t.username," has generated $").concat(null==(s=t.total_commission)?void 0:s.toLocaleString()," in commission with a ").concat(null==(r=t.conversion_rate)?void 0:r.toFixed(1),"% conversion rate."),declining_engagement:"Member engagement scores are declining. Current average: ".concat(null==(n=t.average_engagement_score)?void 0:n.toFixed(1),"%."),high_activity_member:"".concat(t.username," shows exceptional engagement with ").concat(null==(i=t.engagement_score)?void 0:i.toFixed(1),"% engagement score."),churn_risk:"".concat(t.username," has been inactive for ").concat(t.days_since_last_activity," days and shows declining engagement metrics."),rapid_growth:"Member base has grown by ".concat(null==(l=t.member_growth_rate)?void 0:l.toFixed(1),"% in the last ").concat(t.timeframe,", exceeding expectations."),revenue_anomaly:"Revenue patterns show unusual volatility. Revenue changed by ".concat(null==(c=t.revenue_growth_rate)?void 0:c.toFixed(1),"% recently.")})[e.id]||e.description}calculateTrend(e){if(e.length<2)return 0;let t=e.slice(-7).reduce((e,t)=>e+t,0)/Math.min(7,e.length),a=e.slice(-14,-7).reduce((e,t)=>e+t,0)/Math.min(7,e.length);return 0!==a?(t-a)/a*100:0}getTimeframeStartDate(e){let t=new Date;switch(e){case"7d":return new Date(t.getTime()-6048e5);case"30d":default:return new Date(t.getTime()-2592e6);case"90d":return new Date(t.getTime()-7776e6)}}async saveInsights(e){if(0===e.length)return;let{error:t}=await n.N.from("creator_insights").insert(e);t&&console.error("Error saving insights:",t)}async getInsights(e,t){let a=n.N.from("creator_insights").select("*").eq("company_id",e).order("created_at",{ascending:!1});if(t&&(t.type&&(a=a.eq("type",t.type)),t.category&&(a=a.eq("category",t.category)),t.priority&&(a=a.eq("priority",t.priority)),void 0!==t.acknowledged&&(a=a.eq("acknowledged",t.acknowledged)),t.timeframe)){let e=this.getTimeframeStartDate(t.timeframe);a=a.gte("created_at",e.toISOString())}let{data:s,error:r}=await a;if(r)throw r;return s||[]}async acknowledgeInsight(e,t){let{error:a}=await n.N.from("creator_insights").update({acknowledged:!0,acknowledged_at:new Date().toISOString(),acknowledged_by:t}).eq("id",e);if(a)throw a}async getInsightStats(e){let{data:t}=await n.N.from("creator_insights").select("*").eq("company_id",e).order("created_at",{ascending:!1}).limit(100),a=t||[];return{total_insights:a.length,acknowledged_insights:a.filter(e=>e.acknowledged).length,insights_by_type:this.groupByField(a,"type"),insights_by_priority:this.groupByField(a,"priority"),recent_insights:a.slice(0,10)}}groupByField(e,t){return e.reduce((e,a)=>{let s=a[t];return e[s]=(e[s]||0)+1,e},{})}async executeInsightActions(e){let t=this.configs.get(e.config_id);if(t)for(let a of t.actions)await this.executeAction(a,e)}async executeAction(e,t){switch(e.type){case"notification":console.log("Sending notification: ".concat(e.template));break;case"email":console.log("Sending email: ".concat(e.template));break;case"badge":console.log("Awarding badge: ".concat(e.template));break;case"quest":console.log("Creating quest: ".concat(e.template));break;case"message":console.log("Sending message: ".concat(e.template))}}constructor(){this.configs=new Map,this.cache=new Map,this.CACHE_DURATION=6e5,this.initializeDefaultConfigs()}}function g(e){var t,a;let{companyId:n}=e,[i,l]=(0,r.useState)([]),[c,o]=(0,r.useState)(null),[d,g]=(0,r.useState)(!0),[h,x]=(0,r.useState)(null),[u,p]=(0,r.useState)(!1),[y,v]=(0,r.useState)(null),[f,b]=(0,r.useState)({type:"",category:"",priority:"",acknowledged:""});new m,(0,r.useEffect)(()=>{_(),j()},[n,f]);let _=async()=>{try{g(!0);let e=await fetch("/api/insights/recommendations?companyId=".concat(n,"&").concat(new URLSearchParams(f)));if(e.ok){let t=await e.json();l(t)}x(null)}catch(e){console.error("Error fetching insights:",e),x("Failed to load insights")}finally{g(!1)}},j=async()=>{try{let e=await fetch("/api/insights/recommendations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:n,action:"getStats"})});if(e.ok){let t=await e.json();o(t)}}catch(e){console.error("Error fetching stats:",e)}},w=async()=>{try{p(!0);let e=await fetch("/api/insights/recommendations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:n,action:"generate",timeframe:"30d"})});if(e.ok){let t=await e.json();l(t),await j()}}catch(e){console.error("Error generating insights:",e),x("Failed to generate insights")}finally{p(!1)}},N=async e=>{try{(await fetch("/api/insights/recommendations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({companyId:n,action:"acknowledge",insightId:e,acknowledgedBy:"creator"})})).ok&&(l(t=>t.map(t=>t.id===e?{...t,acknowledged:!0,acknowledged_at:new Date().toISOString()}:t)),await j())}catch(e){console.error("Error acknowledging insight:",e)}},S=e=>({trend:"\uD83D\uDCC8",opportunity:"\uD83D\uDCA1",warning:"⚠️",achievement:"\uD83C\uDFC6",recommendation:"\uD83C\uDFAF"})[e]||"\uD83D\uDCA1",C=e=>({trend:"border-blue-200 bg-blue-50",opportunity:"border-green-200 bg-green-50",warning:"border-yellow-200 bg-yellow-50",achievement:"border-purple-200 bg-purple-50",recommendation:"border-indigo-200 bg-indigo-50"})[e]||"border-gray-200 bg-gray-50",D=e=>({low:"bg-gray-100 text-gray-800",medium:"bg-yellow-100 text-yellow-800",high:"bg-orange-100 text-orange-800",critical:"bg-red-100 text-red-800"})[e]||"bg-gray-100 text-gray-800";return d?(0,s.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):h?(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,s.jsx)("p",{className:"text-red-800",children:h})}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{className:"text-2xl font-bold text-gray-900",children:"Insights & Recommendations"}),(0,s.jsx)("p",{className:"text-gray-600",children:"AI-powered insights to optimize your community"})]}),(0,s.jsx)("div",{className:"flex items-center space-x-4",children:(0,s.jsx)("button",{onClick:w,disabled:u,className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u?(0,s.jsxs)("span",{className:"flex items-center",children:[(0,s.jsx)("span",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Generating..."]}):"Generate Insights"})})]}),c&&(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"\uD83D\uDCCA"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Total Insights"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:c.total_insights})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"✅"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Acknowledged"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:c.acknowledged_insights})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"⚠️"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"High Priority"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:(null==(t=c.insights_by_priority)?void 0:t.high)||0})]})}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-3xl mb-2",children:"\uD83C\uDFAF"}),(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"Actionable"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-gray-900",children:i.filter(e=>e.actionable&&!e.acknowledged).length})]})})]}),(0,s.jsx)("div",{className:"bg-white rounded-lg shadow p-6",children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Type"}),(0,s.jsxs)("select",{value:f.type,onChange:e=>b(t=>({...t,type:e.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"",children:"All Types"}),(0,s.jsx)("option",{value:"trend",children:"Trend"}),(0,s.jsx)("option",{value:"opportunity",children:"Opportunity"}),(0,s.jsx)("option",{value:"warning",children:"Warning"}),(0,s.jsx)("option",{value:"achievement",children:"Achievement"}),(0,s.jsx)("option",{value:"recommendation",children:"Recommendation"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Category"}),(0,s.jsxs)("select",{value:f.category,onChange:e=>b(t=>({...t,category:e.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"",children:"All Categories"}),(0,s.jsx)("option",{value:"performance",children:"Performance"}),(0,s.jsx)("option",{value:"engagement",children:"Engagement"}),(0,s.jsx)("option",{value:"retention",children:"Retention"}),(0,s.jsx)("option",{value:"growth",children:"Growth"}),(0,s.jsx)("option",{value:"revenue",children:"Revenue"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Priority"}),(0,s.jsxs)("select",{value:f.priority,onChange:e=>b(t=>({...t,priority:e.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"",children:"All Priorities"}),(0,s.jsx)("option",{value:"low",children:"Low"}),(0,s.jsx)("option",{value:"medium",children:"Medium"}),(0,s.jsx)("option",{value:"high",children:"High"}),(0,s.jsx)("option",{value:"critical",children:"Critical"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Status"}),(0,s.jsxs)("select",{value:f.acknowledged,onChange:e=>b(t=>({...t,acknowledged:e.target.value})),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[(0,s.jsx)("option",{value:"",children:"All Status"}),(0,s.jsx)("option",{value:"false",children:"Pending"}),(0,s.jsx)("option",{value:"true",children:"Acknowledged"})]})]})]})}),(0,s.jsx)("div",{className:"space-y-4",children:0===i.length?(0,s.jsxs)("div",{className:"text-center py-12",children:[(0,s.jsx)("div",{className:"text-6xl mb-4",children:"\uD83D\uDCA1"}),(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Insights Available"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Generate new insights to get AI-powered recommendations for your community."}),(0,s.jsx)("button",{onClick:w,disabled:u,className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Generate First Insights"})]}):i.map(e=>(0,s.jsx)("div",{className:"border-l-4 p-6 rounded-lg ".concat(C(e.type)," ").concat(e.acknowledged?"opacity-75":""),children:(0,s.jsx)("div",{className:"flex items-start justify-between",children:(0,s.jsxs)("div",{className:"flex items-start space-x-4 flex-1",children:[(0,s.jsx)("span",{className:"text-3xl",children:S(e.type)}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:e.title}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(D(e.priority)),children:e.priority}),e.acknowledged&&(0,s.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Acknowledged"})]})]}),(0,s.jsx)("p",{className:"text-gray-700 mb-3",children:e.description}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4 text-sm text-gray-500",children:[(0,s.jsx)("span",{className:"capitalize",children:e.category}),(0,s.jsx)("span",{children:"•"}),(0,s.jsx)("span",{children:new Date(e.created_at).toLocaleDateString()})]}),e.actionable&&!e.acknowledged&&(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsx)("button",{onClick:()=>N(e.id),className:"text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition-colors",children:"Acknowledge"}),(0,s.jsx)("button",{onClick:()=>v(e),className:"text-sm border border-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-50 transition-colors",children:"View Details"})]})]})]})]})})},e.id))}),y&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsx)("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto",children:(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,s.jsx)("span",{className:"text-3xl",children:S(y.type)}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-bold text-gray-900",children:y.title}),(0,s.jsx)("p",{className:"text-gray-600 capitalize",children:y.category})]})]}),(0,s.jsx)("button",{onClick:()=>v(null),className:"text-gray-400 hover:text-gray-600",children:(0,s.jsx)("span",{className:"text-2xl",children:"\xd7"})})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Description"}),(0,s.jsx)("p",{className:"text-gray-700",children:y.description})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-semibold text-gray-900 mb-2",children:"Details"}),(0,s.jsx)("div",{className:"bg-gray-50 rounded-lg p-4",children:(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Type:"}),(0,s.jsx)("span",{className:"ml-2 font-medium capitalize",children:y.type})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Priority:"}),(0,s.jsx)("span",{className:"ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ".concat(D(y.priority)),children:y.priority})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Created:"}),(0,s.jsx)("span",{className:"ml-2 font-medium",children:new Date(y.created_at).toLocaleString()})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("span",{className:"text-gray-600",children:"Actionable:"}),(0,s.jsx)("span",{className:"ml-2 font-medium",children:y.actionable?"Yes":"No"})]})]})})]}),(a=y.data)?(0,s.jsxs)("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg",children:[(0,s.jsx)("h5",{className:"font-medium text-gray-900 mb-2",children:"Details"}),(0,s.jsx)("div",{className:"space-y-1 text-sm",children:Object.entries(a).map(e=>{let[t,a]=e;return(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsxs)("span",{className:"text-gray-600 capitalize",children:[t.replace(/_/g," "),":"]}),(0,s.jsx)("span",{className:"font-medium",children:"number"==typeof a&&t.includes("rate")||t.includes("percentage")?"".concat(a.toFixed(1),"%"):"number"==typeof a?a.toLocaleString():String(a)})]},t)})})]}):null,(0,s.jsxs)("div",{className:"flex justify-end space-x-4",children:[(0,s.jsx)("button",{onClick:()=>v(null),className:"px-4 py-2 text-gray-700 hover:text-gray-900",children:"Close"}),y.actionable&&!y.acknowledged&&(0,s.jsx)("button",{onClick:()=>{N(y.id),v(null)},className:"bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors",children:"Acknowledge Insight"})]})]})]})})})]})}var h=a(4959),x=a(1616),u=a(828);function p(){var e;let{user:t,isLoading:a}=(0,h.X)(),n=(0,x.useRouter)(),[i,c]=(0,r.useState)("dashboard");if(a)return(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})});if(!t)return n.push("/login"),null;let m=(null==t||null==(e=t.metadata)?void 0:e.companyId)||u.env.NEXT_PUBLIC_DEFAULT_COMPANY_ID||"default";return(0,s.jsxs)("div",{className:"min-h-screen bg-gray-50",children:[(0,s.jsx)("header",{className:"bg-white shadow-sm border-b border-gray-200",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsxs)("div",{className:"flex justify-between items-center h-16",children:[(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Creator Tools"}),(0,s.jsx)("p",{className:"ml-2 text-gray-600",children:"Analytics and management tools for your community"})]}),(0,s.jsx)("div",{className:"flex items-center space-x-4",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2 text-sm text-gray-600",children:[(0,s.jsx)("span",{className:"font-medium",children:null==t?void 0:t.username}),(0,s.jsx)("span",{children:"•"}),(0,s.jsx)("span",{children:"Creator"})]})})]})})}),(0,s.jsx)("div",{className:"bg-white border-b border-gray-200",children:(0,s.jsx)("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsx)("nav",{className:"-mb-px flex space-x-8",children:[{key:"dashboard",label:"Dashboard",icon:"\uD83D\uDCCA"},{key:"members",label:"Member Directory",icon:"\uD83D\uDC65"},{key:"reports",label:"Reports",icon:"\uD83D\uDCC4"},{key:"insights",label:"Insights",icon:"\uD83D\uDCA1"}].map(e=>(0,s.jsxs)("button",{onClick:()=>c(e.key),className:"\n                  py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2\n                  ".concat(i===e.key?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300","\n                "),children:[(0,s.jsx)("span",{children:e.icon}),(0,s.jsx)("span",{children:e.label})]},e.key))})})}),(0,s.jsxs)("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:["dashboard"===i&&(0,s.jsx)(l,{companyId:m}),"members"===i&&(0,s.jsx)(o,{companyId:m}),"reports"===i&&(0,s.jsx)(d,{companyId:m}),"insights"===i&&(0,s.jsx)(g,{companyId:m})]})]})}},4959:(e,t,a)=>{"use strict";a.d(t,{X:()=>r});var s=a(5121);function r(){let{user:e,loading:t,error:a}=(0,s.J)();return{user:e?{id:e.id,username:e.username,email:e.email,avatar_url:e.avatar_url,metadata:{companyId:e.company_id,...e.raw_user_meta}}:null,isLoading:t,error:a}}},5121:(e,t,a)=>{"use strict";a.d(t,{J:()=>o,UserProvider:()=>c});var s=a(5010),r=a(8602),n=a(9030),i=a(1616);let l=(0,r.createContext)(void 0);function c(e){let{children:t}=e,[a,c]=(0,r.useState)(null),[o,d]=(0,r.useState)(!0),[m,g]=(0,r.useState)(null);(0,i.useRouter)();let h=async()=>{try{d(!0),g(null);let{data:{session:t},error:a}=await n.N.auth.getSession();if(a)throw a;if(!t)return void c(null);let{data:s,error:r}=await n.N.from("users").select("*").eq("id",t.user.id).single();if(r&&"PGRST116"!==r.code)throw r;if(s)c(s);else{var e;let{data:a,error:s}=await n.N.from("users").insert({id:t.user.id,username:(null==(e=t.user.user_metadata)?void 0:e.username)||"user_".concat(t.user.id.slice(0,8)),email:t.user.email,character_class:"scout",level:1,experience_points:0,prestige_level:0,total_referrals:0,total_commission:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(s)throw s;c(a)}}catch(e){console.error("Error refreshing user:",e),g(e instanceof Error?e.message:"Unknown error"),c(null)}finally{d(!1)}},x=async e=>{if(a)try{let{data:t,error:s}=await n.N.from("users").update({...e,updated_at:new Date().toISOString()}).eq("id",a.id).select().single();if(s)throw s;c(t)}catch(e){throw console.error("Error updating user:",e),g(e instanceof Error?e.message:"Unknown error"),e}};return(0,r.useEffect)(()=>{h();let{data:{subscription:e}}=n.N.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e||"TOKEN_REFRESHED"===e?await h():"SIGNED_OUT"===e&&(c(null),d(!1))});return()=>{e.unsubscribe()}},[]),(0,s.jsx)(l.Provider,{value:{user:a,loading:o,error:m,refreshUser:h,updateUser:x},children:t})}function o(){let e=(0,r.useContext)(l);if(void 0===e)throw Error("useUser must be used within a UserProvider");return e}},9030:(e,t,a)=>{"use strict";a.d(t,{N:()=>l});var s=a(2104),r=a(828);let n="https://slftjqvrjdkzvzenmvnq.supabase.co",i=r.env.SUPABASE_SERVICE_ROLE_KEY,l=(0,s.UU)(n,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZnRqcXZyamRrenZ6ZW5tdm5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxMTE2MjAsImV4cCI6MjA3MzY4NzYyMH0.u2TE7n2o6kd1oaZtoCBxDQV09n5dqlcejEMXx7O_XHY",{auth:{persistSession:!1}});(0,s.UU)(n,i,{auth:{persistSession:!1}})}},e=>{var t=t=>e(e.s=t);e.O(0,[3273,1473,769,7358],()=>t(196)),_N_E=e.O()}]);